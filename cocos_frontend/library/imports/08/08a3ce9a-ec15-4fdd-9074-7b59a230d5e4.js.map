{"version":3,"sources":["assets/Script/mg/ICPManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":[" \nimport UIManager from \"../UIManager\";\nimport LoginManager from \"./LoginManager\";\nimport { DFX_NETWORK, LEAGER_ICP_ID_LOCAL } from \"./DefData\";\n\n//可以用\nimport { Principal } from \"@dfinity/principal\";\n\n//不能用\n// import { Actor, HttpAgent } from \"@dfinity/agent\";\n// import { idlFactory } from \"./icp_ledger.did\";\n\nimport DfinityAgent = require(\"../Lib/dfinity-agent\");\nimport { idlFactory } from \"./icp_ledger.did\";\nconst Actor = (DfinityAgent as any).Actor;\nconst HttpAgent = (DfinityAgent as any).HttpAgent;\n\n\n\n\nexport default class ICPManager {\n    public static readonly Instance: ICPManager = new ICPManager();\n    private ICPManager(){\n    }           \n \n    Init(){\n   \n        \n    }\n\n    private ledgerActor: any = null;\n    private ledgerCanisterId: string | null = null;\n\n\n    private getAgentHost(): string | undefined {\n        if (DFX_NETWORK === 'local') {\n            return 'http://127.0.0.1:4943';\n        }\n        return 'https://ic0.app';\n    }\n\n    private getDefaultLedgerCanisterId(): string {\n        if (DFX_NETWORK === 'local') {\n            return LEAGER_ICP_ID_LOCAL;\n        }\n        // ICP Ledger canister id on mainnet\n        return 'ryjl3-tyaaa-aaaaa-aaaba-cai';\n    }\n\n    private async ensureLedgerActor(strLedgerCanisterId?: string): Promise<any> {\n       // strLedgerCanisterId = \"ryjl3-tyaaa-aaaaa-aaaba-cai\";\n\n        const canisterId = (strLedgerCanisterId && strLedgerCanisterId.trim())\n            ? strLedgerCanisterId.trim()\n            : this.getDefaultLedgerCanisterId();\n\n        cc.log(\"ICPManager: ensureLedgerActor using canisterId:\", canisterId);\n\n        if (this.ledgerActor && this.ledgerCanisterId === canisterId) {\n            return this.ledgerActor;\n        }\n\n        await LoginManager.Instance.ensureAuthClient();\n        const identity = await LoginManager.Instance.getIdentity();\n\n        const host = this.getAgentHost();\n        // Cocos 运行环境下，query 签名验证会触发 fetchSubnetKeys -> canisterStatus.request，\n        // 某些环境会在 encodePath 阶段出现 \"[object Set]\" 的路径编码异常。\n        // 为保证查询/转账流程可用，这里先关闭 query 签名验证。\n        const agent = new HttpAgent({ identity, host, verifyQuerySignatures: false });\n        if (DFX_NETWORK === 'local' && agent && agent.fetchRootKey) {\n            await agent.fetchRootKey();\n        }\n        //如果不是本地环境，不用调用 fetchRootKey\n\n        this.ledgerActor = Actor.createActor(idlFactory, { agent, canisterId });\n        this.ledgerCanisterId = canisterId;\n        return this.ledgerActor;\n    }\n\n    private parseIcpToE8s(amountText: string): number {\n        const s = (amountText || '').trim();\n        if (!s) throw new Error('amount is empty');\n        if (!/^[0-9]+(\\.[0-9]+)?$/.test(s)) throw new Error('invalid amount');\n\n        const [intPart, fracPartRaw] = s.split('.');\n        const fracPart = (fracPartRaw || '');\n        if (fracPart.length > 8) throw new Error('too many decimals (max 8)');\n\n        const fracPadded = (fracPart + '00000000').slice(0, 8);\n\n        // 用 number 表示 e8s（TS target=es5，不使用 BigInt）。\n        // 注意：只能安全表示 <= Number.MAX_SAFE_INTEGER 的 e8s。\n        const e8s = parseInt(intPart, 10) * 100000000 + parseInt(fracPadded, 10);\n        if (!Number.isFinite(e8s) || e8s < 0) {\n            throw new Error('invalid amount');\n        }\n        if (e8s > Number.MAX_SAFE_INTEGER) {\n            throw new Error('amount too large');\n        }\n        return e8s;\n    }\n\n    async GetBalance(principalText: string, strLedgerCanisterId: string): Promise<string> {\n        const pText = (principalText || '').trim();\n        if (!pText) return 'Balance: 0 ICP';\n\n        const actor = await this.ensureLedgerActor(strLedgerCanisterId);\n\n        cc.log(\"GetBalance principalText=\",principalText);\n        \n        const owner =  Principal.fromText(pText);\n        const balanceE8sAny: any = await actor.icrc1_balance_of({ owner, subaccount: [] });\n        const balanceE8sNum = Number(balanceE8sAny && balanceE8sAny.toString ? balanceE8sAny.toString() : balanceE8sAny);\n        const balance = balanceE8sNum / 1e8;\n        cc.log(\"GetBalance balance=\", balance);\n        return `Balance: ${balance.toFixed(8)} ICP`;\n    }\n\n    async SendICP(toPrincipalText: string, amountText: string, strLedgerCanisterId: string): Promise<string> {\n        \n   \n\n        const toText = (toPrincipalText || '').trim();\n        if (!toText) throw new Error('to address is empty');\n\n        const actor = await this.ensureLedgerActor(strLedgerCanisterId);\n        cc.log(\"SendICP toText=\",toText);\n        const toOwner = Principal.fromText(toText);\n        cc.log(\"SendICP toOwner=\", toOwner);\n        const amountE8s = this.parseIcpToE8s(amountText);\n\n        cc.log(`SendICP to=${toText} amount=${amountText} (${amountE8s} e8s)`);\n\n        // Standard ICP fee is 10_000 e8s (0.0001 ICP)\n        // const feeE8s = 10000;\n\n        const res = await actor.icrc1_transfer({\n            from_subaccount: [],\n            to: { owner: toOwner, subaccount: [] },\n            fee: [], // Use default fee\n            memo: [],\n            created_at_time: [],\n            amount: amountE8s,\n        });\n\n        if (res && (res.Ok !== undefined)) {\n            UIManager.ShowTip(`SendICP ok, blockIndex=${res.Ok}`);\n            return `OK: blockIndex=${res.Ok}`;\n        }\n        const err = res && res.Err ? res.Err : res;\n        // JSON.stringify cannot handle BigInt by default\n        const errStr = JSON.stringify(err, (key, value) => (typeof value === 'bigint' ? value.toString() : value));\n        throw new Error(`SendICP failed: ${errStr}`);\n    }\n\n    \n}\n"]}