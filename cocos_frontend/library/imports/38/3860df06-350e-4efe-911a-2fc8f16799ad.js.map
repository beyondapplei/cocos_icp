{"version":3,"sources":["assets/Script/ui/TableView.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["\nexport class CellData{\n    nId:number;\n    node:cc.Node;\n\n\n}\n\nconst {ccclass, property} = cc._decorator;\n@ccclass\nexport  class TableView extends cc.Component {\n\n    @property(cc.Node)\n    scrollViewNode: cc.Node = null;\n\n    @property(cc.Node)\n    nodeElement: cc.Node = null;\n\n    nAllNum:number = 0;\n    scrollView:cc.ScrollView = null;\n    _isUsedCellsDirty:boolean = false;\n    _indices:{[key:number]:number} = {};\n    _vCellsPositions:number[] = [];\n    _cellsUsed:Array<CellData> = [];\n    _cellsFreed:Array<CellData> = new Array<CellData>();\n\n    target:any;\n    refreshCellCallBack:Function;\n    getCellHeightCallBack:Function;\n\n    setRefreshCellCallBack(target:any, refreshCell: Function, getCellHeight?: Function)\n    {\n        this.target = target;\n        this.refreshCellCallBack = refreshCell;\n        this.getCellHeightCallBack = getCellHeight;\n    }\n    onLoad(){\n\n        this.scrollView = this.scrollViewNode.getComponent(cc.ScrollView);\n        this.scrollViewNode.on('scrolling', this.scrollViewDidScroll, this);\n\n        this.scrollViewNode.on('scrolling', this.scrollViewDidScroll, this);\n    }\n    \n    indexFromOffset(search: number)\n    {\n        let low = 0;\n        let high = this.nAllNum - 1;\n        while (high >= low)\n        {\n            let index = low + Math.floor( (high - low) / 2);\n            let cellStart = this._vCellsPositions[index];\n            let cellEnd = this._vCellsPositions[index + 1];\n\n            if (search >= cellStart && search <= cellEnd)\n            {\n                return index;\n            }\n            else if (search < cellStart)\n            {\n                high = index - 1;\n            }\n            else\n            {\n                low = index + 1;\n            }\n        }\n\n        //if (low <= 0) {\n        //    return 0;\n        //}\n\n        return -1;\n    }\n\n    updateCellPositions()\n    {\n        this._vCellsPositions = [];\n        if (this.nAllNum > 0)\n        {\n            let currentPos = 0;\n            for (let nIndex=0; nIndex < this.nAllNum; nIndex++)\n            {\n                this._vCellsPositions[nIndex] = currentPos;\n                let nHeight = this.getCellHeightCallBack.call(this.target,nIndex);\n                currentPos += nHeight;\n            }\n            this._vCellsPositions[this.nAllNum] = currentPos;//1 extra value allows us to get right/bottom of the last cell\n        }\n\n    }\n    updateContentSize()\n    {\n        if (this.nAllNum <= 0)\n        {\n            return\n        }\n        let nHeight = this._vCellsPositions[this.nAllNum];\n        //let contentWidth = this.scrollView.content.getContentSize().width;\n        let nTableViewHeight = this.scrollViewNode.getContentSize().height;\n        if(nHeight < nTableViewHeight)\n        {\n            nHeight = nTableViewHeight;\n        }\n        this.scrollView.content.height = nHeight;\n    }\n\n\n    reloadData(nCount:number)\n    {\n        this.nAllNum = nCount;\n        for(let nIndex=0; nIndex< this._cellsUsed.length; ++nIndex) \n        {\n            let cell = this._cellsUsed[nIndex];\n            this._cellsFreed.push(cell);\n            cell.node.removeFromParent(false);\n        }\n\n        this._indices = {};\n        this._cellsUsed = [];\n    \n        this.updateCellPositions();\n        this.updateContentSize();\n        this.scrollViewDidScroll(this.scrollView);\n    }\n\n    moveCellOutOfSight(cellData: CellData)\n    {\n        this._cellsFreed.push(cellData);\n        this._cellsUsed.splice(this._cellsUsed.indexOf(cellData), 1);\n        this._isUsedCellsDirty = true;\n        delete this._indices[cellData.nId];\n        cellData.node.removeFromParent(false);    \n    }\n    scrollViewDidScroll(scrollView: cc.ScrollView)\n    {\n        if (this.nAllNum === 0)\n        {\n            return;\n        }\n        if (this._isUsedCellsDirty)\n        {\n            this._isUsedCellsDirty = false;\n            this._cellsUsed.sort(function (v1:CellData, v2:CellData):number\n            {\n                return v1.nId - v2.nId;\n            });\n        }\n        let nContentPosY = this.scrollView.content.position.y ; //-100\n        if(nContentPosY < 0)\n        {\n            nContentPosY = 0;\n        }\n        let nTableViewHeight = this.scrollViewNode.height;\n        let nBeginPosY = Math.abs(nContentPosY);\n        let nEndPosY = nBeginPosY+nTableViewHeight;\n\n        let startIdx = this.indexFromOffset(nBeginPosY);\n        let endIdx   = this.indexFromOffset(nEndPosY);\n        if(startIdx === -1)\n        {\n            //startIdx = this.nAllNum - 1;\n            startIdx = 0;\n        }\n        if(endIdx === -1)\n        {\n            endIdx = this.nAllNum - 1;\n        }\n        let idx = 0;\n\n        if(this._cellsUsed.length > 0)\n        {\n            let cellData = this._cellsUsed[0];\n            idx = cellData.nId;\n            \n            while(idx < startIdx)\n            {\n                this.moveCellOutOfSight(cellData);\n                if (this._cellsUsed.length >0 )\n                {\n                    cellData = this._cellsUsed[0];\n                    idx = cellData.nId;\n                }\n                else\n                {\n                    break;\n                }\n            }\n        }\n        \n        if (this._cellsUsed.length > 0)\n        {\n            let cellData = this._cellsUsed[this._cellsUsed.length-1];\n            idx = cellData.nId;\n            while(idx <= this.nAllNum-1 && idx > endIdx)\n            {\n                this.moveCellOutOfSight(cellData);\n                if (this._cellsUsed.length > 0)\n                {\n                    cellData = this._cellsUsed[this._cellsUsed.length-1];\n                    idx = cellData.nId;\n                }\n                else\n                {\n                    break;\n                }\n            }\n        }\n\n        for (let i = startIdx; i <= endIdx; i++)\n        {\n            if (this._indices[i] != null)\n            {\n                continue;\n            }\n            this.updateCellAtIndex(i);\n        }\n    }\n\n    createElementNode()\n    {\n        return cc.instantiate(this.nodeElement);\n    }\n    dequeueCell()\n    {\n        if (this._cellsFreed.length === 0 ){\n            //let cell = new CellData();\n            //cell.node = cc.instantiate(this.nodeElement);\n            return null;\n        }\n        else {\n            let cell = this._cellsFreed[0];\n            this._cellsFreed.splice(0,1)\n            return cell;\n        }\n    }\n\n    updateCellAtIndex( idx:number)\n    {\n        //let cellData = this.dequeueCell();\n\n        let cellData = this.refreshCellCallBack.call(this.target,idx)\n        cellData.nId = idx;\n        cellData.node.setPosition(new cc.Vec2(0,-this._vCellsPositions[idx]));\n        this.scrollView.content.addChild(cellData.node);\n        this._cellsUsed.push(cellData);\n        this._indices[idx] = idx;\n        this._isUsedCellsDirty = true;\n    }\n\n    addCellAtLast()\n    {\n        this.nAllNum = this.nAllNum + 1;\n        this.updateCellPositions();\n        this.updateContentSize();\n        //this.scrollViewDidScroll(this.scrollView);\n\n/*\n        let idx = this.nAllNum - 1;\n        let cellData = this.refreshCellCallBack.call(this.target,idx)\n        cellData.nId = idx;\n        //cellData.node.setPosition(new cc.Vec2(0,-this._vCellsPositions[idx]));\n        this.scrollView.content.addChild(cellData.node);\n        //this._cellsUsed.push(cellData);\n        //this._indices[idx] = idx;\n        //this._isUsedCellsDirty = true;*/\n    }\n\n    onDestroy(){\n\n    }\n    start () {\n    }\n    \n    update(){\n    }\n\n    lateUpdate(){\n\n    }\n\n}\n"]}