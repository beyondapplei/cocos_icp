{"version":3,"sources":["assets/Script/mg/BackManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import \"./GlobalPolyfill\";\n\nimport LoginManager from \"./LoginManager\";\nimport { ethers } from \"ethers\";\nimport DfinityAgent = require(\"../Lib/dfinity-agent\");\nimport { idlFactory } from \"./backend.did\";\n\nconst Actor = (DfinityAgent as any).Actor;\nconst HttpAgent = (DfinityAgent as any).HttpAgent;\n\nimport { DFX_NETWORK, II_CANISTER_ID_LOCAL,BACKEND_CANISTER_ID_LOCAL_FALLBACK } from \"./DefData\";\n\n\n\nexport default class BackManager {\n    public static readonly Instance: BackManager = new BackManager();\n    private constructor() {}\n\n    private backendActor: any = null;\n\n\n    Init() {\n        // 预加载后端交互所需的脚本\n    }\n\n    // private isEditorOrPreview(): boolean {\n    //     return ((typeof CC_EDITOR !== 'undefined' && (CC_EDITOR as any)) ||\n    //         (typeof CC_PREVIEW !== 'undefined' && (CC_PREVIEW as any))) as any;\n    // }\n\n    private getGlobal(): any {\n        return (typeof globalThis !== 'undefined'\n            ? globalThis\n            : (typeof window !== 'undefined'\n                ? window\n                : (typeof self !== 'undefined' ? self : {})));\n    }\n\n    private getBackendCanisterId(): string | null {\n        const g = this.getGlobal();\n        const injected = (g && (g.CANISTER_ID_backend || g.CANISTER_ID_BACKEND || g.BACKEND_CANISTER_ID)) as string | undefined;\n        if (injected && typeof injected === 'string' && injected.length > 0) return injected;\n        if (DFX_NETWORK === 'local') return BACKEND_CANISTER_ID_LOCAL_FALLBACK;\n        return null;\n    }\n\n    private getAgentHost(): string | undefined {\n        const g = this.getGlobal();\n        // 如果是本地开发环境，强制指向本地 replica 地址，避免 Cocos Preview (localhost:7456) 拦截请求\n        if (DFX_NETWORK === 'local') {\n            return 'http://127.0.0.1:4943';\n        }\n        // 如果是 IC 主网，host 设为 undefined 或 \"https://ic0.app\"，HttpAgent 默认会连接主网\n        return \"https://ic0.app\";\n    }\n\n    private async ensureBackendActor(): Promise<any> {\n        if (this.backendActor) return this.backendActor;\n        //if (this.isEditorOrPreview()) throw new Error('Backend actor disabled in editor/preview');\n\n        await LoginManager.Instance.ensureAuthClient();\n        const identity = await LoginManager.Instance.getIdentity();\n\n        const canisterId = this.getBackendCanisterId();\n        if (!canisterId) throw new Error('Backend canisterId not found');\n\n        const host = this.getAgentHost();\n        const agent = new HttpAgent({ identity, host });\n        if (DFX_NETWORK === 'local' && agent && agent.fetchRootKey) {\n            await agent.fetchRootKey();\n        }\n\n        this.backendActor = Actor.createActor(idlFactory, { agent, canisterId });\n        return this.backendActor;\n    }\n\n    async getEthAddress(): Promise<string> {\n        const actor = await this.ensureBackendActor();\n        \n        const publicKey = await actor.get_eth_public_key();\n        const pkBytes = new Uint8Array(publicKey);\n        return ethers.utils.computeAddress(ethers.utils.hexlify(pkBytes));\n    }\n}\n"]}