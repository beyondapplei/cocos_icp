{"version":3,"sources":["assets/Script/mg/LoginManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["\n//import EventManager from \"../EventManager\";\n\nimport DfinityAuthClient = require(\"../Lib/dfinity-auth-client\");\nconst AuthClient = (DfinityAuthClient as any).AuthClient;\nconst LocalStorage = (DfinityAuthClient as any).LocalStorage;\n\n//import {ECMDID} from \"../CommonEnum\";\n\nimport { DFX_NETWORK, II_CANISTER_ID_LOCAL } from \"./DefData\";\n\n\n\nexport default class LoginManager {\n    public static readonly Instance: LoginManager = new LoginManager();\n    private constructor() {}\n\n    private authClient: any = null;\n\n    private getBrowserLocalStorage(): Storage | null {\n        try {\n            const g: any = (typeof globalThis !== 'undefined')\n                ? globalThis\n                : (typeof window !== 'undefined' ? window : (typeof self !== 'undefined' ? self : {}));\n            return (g && g.localStorage) ? (g.localStorage as Storage) : null;\n        } catch {\n            return null;\n        }\n    }\n\n    private clearAuthClientStorage(): void {\n        const ls = this.getBrowserLocalStorage();\n        if (!ls) return;\n\n        // auth-client 的默认 LocalStorage 前缀是 \"ic-\"，key 为 identity/delegation/iv\n        const keys = [\n            'ic-identity',\n            'ic-delegation',\n            'ic-iv',\n            // 兼容某些环境/旧版本未加前缀的情况\n            'identity',\n            'delegation',\n            'iv',\n        ];\n        for (let i = 0; i < keys.length; i++) {\n            try {\n                ls.removeItem(keys[i]);\n            } catch {\n                // ignore\n            }\n        }\n    }\n\n    Init() {\n        // void this.ensureAuthClient().catch(() => {\n        //     // UI 层自行提示；这里不抛出\n        // });\n    }\n\n    // private isEditorOrPreview(): boolean {\n    //     return ((typeof CC_EDITOR !== 'undefined' && (CC_EDITOR as any)) ||\n    //         (typeof CC_PREVIEW !== 'undefined' && (CC_PREVIEW as any))) as any;\n    // }\n\n    // private getGlobal(): any {\n    //     return (typeof globalThis !== 'undefined'\n    //         ? globalThis\n    //         : (typeof window !== 'undefined'\n    //             ? window\n    //             : (typeof self !== 'undefined' ? self : {})));\n    // }\n\n    public async ensureAuthClient(): Promise<any> {\n        if (this.authClient) return this.authClient;\n\n        // Cocos 环境下 IndexedDB 可能不可用/数据损坏；强制使用 LocalStorage 更稳。\n        try {\n            const client = await AuthClient.create({ storage: new LocalStorage() });\n            if (!client) throw new Error('AuthClient creation failed');\n            this.authClient = client;\n            return this.authClient;\n        } catch (e: any) {\n            const msg = (e && e.message) ? String(e.message) : String(e);\n            // 常见：历史缓存 delegation/identity 损坏导致 DelegationChain.fromJSON 报错\n            if (msg.indexOf('Invalid hexadecimal string') >= 0 || msg.indexOf('DelegationChain') >= 0) {\n                this.clearAuthClientStorage();\n                const client = await AuthClient.create({ storage: new LocalStorage() });\n                if (!client) throw new Error('AuthClient creation failed');\n                this.authClient = client;\n                return this.authClient;\n            }\n            throw e;\n        }\n\n        // unreachable\n    }\n\n    async isAuthenticated(): Promise<boolean> {\n        const client = await this.ensureAuthClient();\n        return !!(await client.isAuthenticated());\n    }\n\n    async getIdentity(): Promise<any> {\n        const client = await this.ensureAuthClient();\n        return client.getIdentity();\n    }\n\n    getPrincipalText(): string | null {\n        if (!this.authClient) return null;\n        try {\n            const identity = this.authClient.getIdentity();\n            return identity.getPrincipal().toText();\n        } catch {\n            return null;\n        }\n    }\n\n    private formatErrorMessage(err: any): string {\n        if (!err) return 'Unknown error';\n        if (typeof err === 'string') return err;\n        if (err instanceof Error && err.message) return err.message;\n        if (typeof err.message === 'string' && err.message) return err.message;\n        if (typeof err.error === 'string' && err.error) return err.error;\n        try {\n            return JSON.stringify(err);\n        } catch {\n            return String(err);\n        }\n    }\n\n    // loginCallBack(): void {\n    //     // no op\n    //     EventManager.Instance.FireEvent(ECMDID.LoginSuccess);\n    // }\n\n    login(onSuccessCallBack?: () => void, onError?: (err: any) => void): void {\n        if (!this.authClient) {\n            if (onError) onError(new Error(\"AuthClient not ready\"));\n            return;\n        }\n\n        let iiUrl = '';\n        if (DFX_NETWORK === 'local') {\n            iiUrl = `http://${II_CANISTER_ID_LOCAL}.localhost:4943/#authorize`;\n        } else {\n            iiUrl = 'https://identity.ic0.app/#authorize';\n        }\n\n        this.authClient.login({\n            identityProvider: iiUrl,\n            onSuccess: () => {\n                if (onSuccessCallBack) onSuccessCallBack();\n            },\n            onError: (err: any) => {\n                const msg = `Login failed: ${this.formatErrorMessage(err)}`;\n                if (onError) onError(new Error(msg));\n            },\n        });\n    }\n}\n"]}