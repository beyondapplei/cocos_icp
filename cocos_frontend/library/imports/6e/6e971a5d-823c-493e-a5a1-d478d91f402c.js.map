{"version":3,"sources":["assets/Script/mg/LoginManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["\nimport EventManager from \"../EventManager\";\nimport \"./GlobalPolyfill\";\nimport DfinityAuthClient = require(\"../Lib/dfinity-auth-client\");\n\nconst AuthClient = (DfinityAuthClient as any).AuthClient;\n\nimport {ECMDID} from \"../CommonEnum\";\n\nimport { DFX_NETWORK, II_CANISTER_ID_LOCAL } from \"./DefData\";\n\n\n\nexport default class LoginManager {\n    public static readonly Instance: LoginManager = new LoginManager();\n    private constructor() {}\n\n    private authClient: any = null;\n\n    Init() {\n        // void this.ensureAuthClient().catch(() => {\n        //     // UI 层自行提示；这里不抛出\n        // });\n    }\n\n    // private isEditorOrPreview(): boolean {\n    //     return ((typeof CC_EDITOR !== 'undefined' && (CC_EDITOR as any)) ||\n    //         (typeof CC_PREVIEW !== 'undefined' && (CC_PREVIEW as any))) as any;\n    // }\n\n    // private getGlobal(): any {\n    //     return (typeof globalThis !== 'undefined'\n    //         ? globalThis\n    //         : (typeof window !== 'undefined'\n    //             ? window\n    //             : (typeof self !== 'undefined' ? self : {})));\n    // }\n\n    public async ensureAuthClient(): Promise<any> {\n        if (this.authClient) return this.authClient;\n        \n        const client = await AuthClient.create();\n        if (!client) throw new Error('AuthClient creation failed');\n        this.authClient = client;\n\n        return this.authClient;\n    }\n\n    async isAuthenticated(): Promise<boolean> {\n        const client = await this.ensureAuthClient();\n        return !!(await client.isAuthenticated());\n    }\n\n    async getIdentity(): Promise<any> {\n        const client = await this.ensureAuthClient();\n        return client.getIdentity();\n    }\n\n    getPrincipalText(): string | null {\n        if (!this.authClient) return null;\n        try {\n            const identity = this.authClient.getIdentity();\n            return identity.getPrincipal().toText();\n        } catch {\n            return null;\n        }\n    }\n\n    private formatErrorMessage(err: any): string {\n        if (!err) return 'Unknown error';\n        if (typeof err === 'string') return err;\n        if (err instanceof Error && err.message) return err.message;\n        if (typeof err.message === 'string' && err.message) return err.message;\n        if (typeof err.error === 'string' && err.error) return err.error;\n        try {\n            return JSON.stringify(err);\n        } catch {\n            return String(err);\n        }\n    }\n\n    // loginCallBack(): void {\n    //     // no op\n    //     EventManager.Instance.FireEvent(ECMDID.LoginSuccess);\n    // }\n\n    login(onSuccessCallBack?: () => void, onError?: (err: any) => void): void {\n        if (!this.authClient) {\n            if (onError) onError(new Error(\"AuthClient not ready\"));\n            return;\n        }\n\n        let iiUrl = '';\n        if (DFX_NETWORK === 'local') {\n            iiUrl = `http://${II_CANISTER_ID_LOCAL}.localhost:4943/#authorize`;\n        } else {\n            iiUrl = 'https://identity.ic0.app/#authorize';\n        }\n\n        this.authClient.login({\n            identityProvider: iiUrl,\n            onSuccess: () => {\n                if (onSuccessCallBack) onSuccessCallBack();\n            },\n            onError: (err: any) => {\n                const msg = `Login failed: ${this.formatErrorMessage(err)}`;\n                if (onError) onError(new Error(msg));\n            },\n        });\n    }\n}\n"]}